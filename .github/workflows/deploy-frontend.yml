name: Deploy Frontend to VPS

on:
  push:
    branches: [main, master, developer]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Frontend to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || 22 }}
        command_timeout: 20m
        script: |
            echo "ğŸ¨ Starting Frontend deployment..."

            # Navegar para o diretÃ³rio do frontend
            cd ${{ secrets.PROJECT_PATH }}/Noto-Front-end || { echo "âŒ Frontend directory not found"; exit 1; }

            # Mostrar branch atual
            echo "ğŸ“ Current branch: $(git branch --show-current)"

            # Pull das mudanÃ§as
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin $(git branch --show-current)

            # Mostrar Ãºltimos commits
            echo "ğŸ“ Recent commits:"
            git log --oneline -3

          # Instalar dependÃªncias
          echo "ğŸ“¦ Installing dependencies..."
          yarn install --frozen-lockfile
          
          # Build do projeto
          echo "ğŸ”¨ Building project..."
          yarn build            # Limpeza e gestÃ£o do processo PM2
            echo "ğŸ§¹ Cleaning up PM2 processes..."

            # Parar e deletar processo existente se houver
            if pm2 describe noto-frontend > /dev/null 2>&1; then
              echo "ğŸ›‘ Stopping existing frontend process..."
              pm2 stop noto-frontend
              pm2 delete noto-frontend
              echo "ğŸ—‘ï¸ Old process removed"
            fi

            # Aguardar um momento para garantir limpeza
            sleep 2

          # Iniciar novo processo
          echo "ğŸ†• Starting fresh frontend process..."
          pm2 start yarn --name "noto-frontend" -- start            # Salvar configuraÃ§Ã£o
            pm2 save

            # Mostrar status
            echo "ğŸ“Š PM2 Status:"
            pm2 status noto-frontend

            # Verificar se estÃ¡ rodando
            sleep 5
            if pm2 describe noto-frontend | grep -q "online"; then
              echo "âœ… Frontend deployed successfully and is running!"
            else
              echo "âŒ Frontend deployment failed!"
              pm2 logs noto-frontend --lines 10
              exit 1
            fi
